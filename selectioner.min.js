(function(e){"use strict";var t=function(){};t.prototype.on=function(e,t,i){var n=e.split(" ");return n.length>1?n.forEach(function(e){this.on(e,t,i)},this):(this._eventHandlers||(this._eventHandlers={}),this._eventHandlers[e]||(this._eventHandlers[e]=[]),this._eventHandlers[e].push({handler:t,context:i?i:this})),this},t.prototype.off=function(e,t){if(!this._eventHandlers)return this;var i=function(e,t){for(var i=0,n=this._eventHandlers[e].length;n>i;i++)this._eventHandlers[e][i].handler==t&&this._eventHandlers[e].splice(i,1)};if(e)if(e&&!t)if("function"!=typeof e){if(!this._eventHandlers[e])return this;this._eventHandlers[e].length=0}else{var n=e;for(var o in this._eventHandlers)i.call(this,o,n)}else{if(!this._eventHandlers[e])return this;i.call(this,e,t)}else delete this._eventHandlers;return this},t.prototype.trigger=function(e,t){if(this._eventHandlers){var i=this._eventHandlers[e];if(i)for(var n=this,o=0,r=i.length;r>o;o++){var s=i[o];s.handler.call(s.context,{target:n,name:e,data:t})}return this}};var i=window.Selectioner=function(t,i,n){if(n instanceof Array||(n=[n]),this.target=t=e(t),this.display=i,this.dialogs=n,t.data("selectioner"))throw Error("Selectioner: The target element has already been processed.");i.initialize(this);for(var o=0,r=n.length;r>o;o++)i.addDialog(n[o]);t.next().html()==this.display.element.html()&&t.next().remove(),t.data("selectioner",this).css("display","none").after(this.display.element)};i.prototype=new t,i.Settings={cssPrefix:"select-",noSelectionText:"Select an option",emptyOptionText:"None",maxAutoCompleteItems:5},i.Core={},i.Dialog={},i.Display={},i.Extensions={},i.Popup={};var n=function(){};n.prototype.initialize=function(t){this.selectioner=t,this.dialogs=[],this.element=e("<div />").addClass(i.Settings.cssPrefix+"popup").css({visibility:"hidden",position:"absolute",zIndex:"-1"}),this.render(),e("body").append(this.element)},n.prototype.addDialog=function(e){e.setPopup(this),this.dialogs.push(e)},n.prototype.render=function(){this.element.empty();for(var e=0,t=this.dialogs.length;t>e;e++){var i=this.dialogs[e];i.render(),this.element.append(i.element)}},n.prototype.reposition=function(){var t=this.selectioner.display.element,i=t.offset(),n=this.element.outerWidth(!1)-this.element.width(),o=t.outerWidth(!1)-n,r=t.outerHeight(!1)+i.top,s=e(window).scrollTop(),l=this.element.outerHeight(!0);this.element.removeClass("below").removeClass("above").removeClass("over"),r+l>e(window).height()+s?(r=i.top-l+1,s>r?(r=s,this.element.addClass("over")):this.element.addClass("above")):this.element.addClass("below"),this.element.css({width:o+"px",left:i.left+"px",top:r+"px"})},n.prototype.show=function(){this.isShown()||(this._isVisible=!0,this.render(),this.reposition(),this.element.css({visibility:"visible",zIndex:""}),this.selectioner.trigger("show.selectioner"))},n.prototype.hide=function(){this.isShown()&&(this._isVisible=!1,this.element.css({visibility:"hidden",zIndex:"-1"}),this.selectioner.trigger("hide.selectioner"))},n.prototype.isShown=function(){return this._isVisible};var o=i.Core.Display=function(){};o.prototype.initialize=function(e){this.selectioner=e,this.validateTarget(),this.createDisplay(),this.createPopup()},o.prototype.createDisplay=function(){var t=this;this.render(),this.update(),this.element.addClass(i.Settings.cssPrefix+"display").prop("tabindex",this.selectioner.target.prop("tabindex"));var n=this.selectioner.target.attr("id");void 0!==n&&(this.labels=e(document).on("click.selectioner",'label[for="'+n+'"]',function(){t.element.focus()}),this.selectioner.target.on("change.selectioner",function(){t.update()}))},o.prototype.createPopup=function(){var t=this.popup=new n;t.initialize(this.selectioner);var o=this.selectioner.display.element;this.element.on("focusin.selectioner",function(){t.show()}).children().andSelf().on("mousedown.selectioner",function(e){e.stopPropagation(),t.isShown()?t.hide():t.show()}),e(document).on("mousedown.selectioner focusin.selectioner",function(i){!t.isShown()||i.target===o[0]||e.contains(o[0],i.target)||i.target===t.element[0]||e.contains(t.element[0],i.target)||t.hide()}),e(window).on("resize.selectioner",function(){t.hide()});var r=i.Settings.cssPrefix+"visible";this.selectioner.on("show.selectioner",function(){o.addClass(r)}).on("hide.selectioner",function(){o.removeClass(r)})},o.prototype.addDialog=function(e){e.initialize(this.selectioner),this.popup.addDialog(e)},o.prototype.render=function(){throw Error('The render method needs to be explicity overridden, and must set "this.element" to a jQuery object.')},o.prototype.update=function(){},o.prototype.remove=function(){this.selectioner.target.off(".selectioner"),this.element.add(this.popup.element).remove()};var r=i.Core.Dialog=function(){};r.prototype.initialize=function(e){this.selectioner=e,this.validateTarget()},r.prototype.render=function(){throw Error('The render method needs to be explicity overridden, and must set "this.element" to a jQuery object.')},r.prototype.setPopup=function(e){this.popup=e},r.prototype.validateTarget=function(){};var s=i.Display.ListBox=function(){};s.prototype=new i.Core.Display,s.prototype.validateTarget=function(){if(!this.selectioner.target.is("select"))throw Error("ListBox expects it's underlying target element to to be a <select /> element")},s.prototype.render=function(){this.element=e("<span />"),this.textElement=e("<span />").addClass(i.Settings.cssPrefix+"text");var t=e("<span />").addClass(i.Settings.cssPrefix+"button");this.element.append(t).append(this.textElement)},s.prototype.update=function(){var e=this.selectioner.target.find("option:selected");if(this.textElement.removeClass("none"),0===e.length||e.is('option[value=""], option:empty:not([value])')){var t=i.Settings.noSelectionText;t?this.textElement.text(t):this.textElement.html("&nbsp;"),this.textElement.addClass("none")}else if(2>=e.length){for(var n="",o=0,r=e.length;r>o;o++)n+=e[o].text,r-1>o&&(n+=", ");this.textElement.text(n)}else this.textElement.text("Selected "+e.length+" of "+this.selectioner.target.find("option").length)};var l=i.Display.ComboBox=function(){};l.prototype=new i.Core.Display,l.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboBox expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},l.prototype.render=function(){if(this.textElement=this.selectioner.target.next(),!this.textElement.is('input[type="text"]'))throw Error('ComboBox expects the element to follow it\'s target <select /> to be an <input type="text" />');this.textElement.is("[placeholder]")||this.textElement.attr("placeholder",i.Settings.noSelectionText),this.textElement.attr("autocomplete","off");var t=this.getEmptyOptions();if(0===t.length)throw Error("ComboBox elements require an empty and value-less <option></option> in their underlying <select /> elements.");this.element=e("<span />");var n=this;this.textElement.addClass(i.Settings.cssPrefix+"text").on("change.selectioner",function(){n.textChanged()});var o=e("<span />").addClass(i.Settings.cssPrefix+"button");this.element.append(o).append(this.textElement)},l.prototype.textChanged=function(){var t=this.textElement.val().toUpperCase(),i=this.selectioner.target.find("option").filter(function(){return e(this).text().toUpperCase()==t});1!=i.length&&(i=this.getEmptyOptions()),i[0].selected=!0,this.selectioner.target.trigger("change")},l.prototype.update=function(){var e=this.selectioner.target.find("option:selected");this.textElement.removeClass("none");var t=e.text();0===e.length?this.textElement.addClass("none"):""!==t&&this.textElement.val(t)},l.prototype.getEmptyOptions=function(){return this.selectioner.target.find('option[value=""], option:empty:not([value])')},l.prototype.remove=function(){this.selectioner.target.after(this.textElement),i.Core.Display.prototype.remove.call(this)};var a=i.Dialog.SingleSelect=function(){};a.prototype=new i.Core.Dialog,a.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('SingleSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},a.prototype.render=function(){this.element=e("<ul />");for(var t=this.selectioner.target.children(),i=0,n=t.length;n>i;i++){var o=e(t[i]);"OPTION"==t[i].tagName?this.element.append(this.renderOption(o)):"OPTGROUP"==t[i].tagName&&this.element.append(this.renderGroup(o))}},a.prototype.renderOption=function(t){var n=this,o=this.selectioner.target,r=function(){t[0].selected=!0,n.popup.hide(),o.trigger("change")},s=t.text(),l=e("<a />").attr("href","javascript:;").on("click",r).text(s||i.Settings.emptyOptionText),a=e("<li />");return s||a.addClass("none"),a.append(l)},a.prototype.renderGroup=function(t){for(var n=e("<span />").text(t.attr("label")),o=e("<li />").addClass(i.Settings.cssPrefix+"group-title").append(n),r=t.children(),s=0,l=r.length;l>s;s++){var a=e(r[s]);o=o.add(this.renderOption(a))}var p=e("<li />").append(e("<ul >").append(o));return p};var p=i.Dialog.MultiSelect=function(){};p._inputIdIndex=0,p.prototype=new i.Dialog.SingleSelect,p.prototype.validateTarget=function(){if(!this.selectioner.target.is("select[multiple]"))throw Error('MultiSelect expects it\'s underlying target element to to be a <select /> element with a "multiple" attribute')},p.prototype.renderOption=function(t){var i=e("<li />"),n="MultiSelectCheckbox"+p._inputIdIndex++,o=e('<input type="checkbox" />').attr("id",n);t[0].selected&&o.attr("checked","checked");var r=e("<label />").append(o).append(e("<span />").text(t.text())).attr("for",n),s=this.selectioner;return o.on("change.selectioner",function(){t[0].selected=this.checked,s.target.trigger("change")}),i.append(r),i},p.prototype.renderGroup=function(t){for(var n=function(){var t=e(this).closest("ul").find("input:checkbox"),i=t.filter(":checked").length;i>0&&t.length===i?t.prop("checked",!1):t.prop("checked",!0),t.trigger("change.selectioner")},o=e("<a />").attr("href","javascript:;").on("click",n).text(t.attr("label")),r=e("<li />").addClass(i.Settings.cssPrefix+"group-title").append(o),s=t.children(),l=0,a=s.length;a>l;l++){var p=e(s[l]);r=r.add(this.renderOption(p))}var h=e("<li />").append(e("<ul >").append(r));return h};var h=i.Dialog.ComboSelect=function(){};h.prototype=new i.Dialog.SingleSelect,h.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},h.prototype.renderOption=function(e){return e.is('option[value=""], option:empty:not([value])')?null:i.Dialog.SingleSelect.prototype.renderOption.call(this,e)};var c=i.Dialog.AutoComplete=function(){};c.prototype=new i.Core.Dialog,c.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},c.prototype.render=function(){if(this.textElement=this.selectioner.display.element.find('input[type="text"]'),0===this.textElement.length)throw Error('AutoComplete expects the Display to contain an <input type="text" /> element');this.element=e("<ul />"),this.update();var t=this;this.textElement.on("keyup",function(){t.update(),t.popup.isShown()?t.popup.reposition():t.popup.show()}),this.update()},c.prototype.update=function(){for(var t=this,n=function(i){var n=e("<a />").attr("href","javascript:;").text(i.text()).on("click",function(){i[0].selected=!0,t.popup.hide(),t.selectioner.target.trigger("change")});return e("<li />").append(n)},o=this.textElement.val().toLowerCase(),r=this.selectioner.target.find("option"),s=e(),l=0,a=r.length;a>l;l++){var p=e(r[l]),h=p.text().toLowerCase();if(""!==h&&0===h.indexOf(o)&&(s=s.add(n(p)),s.length>i.Settings.maxAutoCompleteItems))break}this.element.empty().append(s)},e.fn.singleSelect=function(){return this.each(function(){new i(this,new i.Display.ListBox,new i.Dialog.SingleSelect)}),this},e.fn.multiSelect=function(){return this.each(function(){new i(this,new i.Display.ListBox,new i.Dialog.MultiSelect)}),this},e.fn.comboSelect=function(e){return this.each(function(){new i(this,new i.Display.ComboBox(e),new i.Dialog.ComboSelect)}),this},e.fn.autoComplete=function(e){return this.each(function(){new i(this,new i.Display.ComboBox(e),new i.Dialog.AutoComplete)}),this}})(jQuery);