(function(e){"use strict";var t=function(){};t.prototype.on=function(e,t,n){var i=e.split(" ");return i.length>1?i.forEach(function(e){this.on(e,t,n)},this):(this._eventHandlers||(this._eventHandlers={}),this._eventHandlers[e]||(this._eventHandlers[e]=[]),this._eventHandlers[e].push({handler:t,context:n?n:this})),this},t.prototype.off=function(e,t){if(!this._eventHandlers)return this;var n=function(e,t){for(var n=0,i=this._eventHandlers[e].length;i>n;n++)this._eventHandlers[e][n].handler==t&&this._eventHandlers[e].splice(n,1)};if(e)if(e&&!t)if("function"!=typeof e){if(!this._eventHandlers[e])return this;this._eventHandlers[e].length=0}else{var i=e;for(var o in this._eventHandlers)n.call(this,o,i)}else{if(!this._eventHandlers[e])return this;n.call(this,e,t)}else delete this._eventHandlers;return this},t.prototype.trigger=function(e,t){if(this._eventHandlers){var n=this._eventHandlers[e];if(n)for(var i=this,o=0,s=n.length;s>o;o++){var r=n[o];r.handler.call(r.context,{target:i,name:e,data:t})}return this}};var n=window.Selectioner=function(t,i,o){if(o instanceof Array||(o=[o]),this.target=t=e(t),this.display=i,this.dialogs=o,t.data("selectioner"))throw Error("The target element has already has a Selectioner associated with it.");t.next().hasClass(n.Settings.cssPrefix+"display")&&t.next().remove(),i.initialize(this);for(var s=0,r=o.length;r>s;s++)i.addDialog(o[s]);t.data("selectioner",this).css("display","none").after(this.display.element)};n.prototype=new t,n.Core={},n.Dialog={},n.Display={},n.Extensions={},n.Popup={},n.Settings={cssPrefix:"select-",noSelectionText:"Select an option",emptyOptionText:"None",maxAutoCompleteItems:5};var i=n.Core.KeyboardReceiver=function(){};i.prototype.onKeyDown=function(){},i.prototype.getKeyboardFocus=function(){i._currentReceiver=this},i.prototype.removeKeyboardFocus=function(){i._currentReceiver===this&&(i._currentReceiver=null)},e(document).off("keydown.selectioner").on("keydown.selectioner",function(e){i._currentReceiver&&i._currentReceiver.onKeyDown(e.which||e.keyCode,e)});var o=function(){};o.prototype=new n.Core.KeyboardReceiver,o.prototype.initialize=function(t){var i=this;this.selectioner=t,this.dialogs=[],this.element=e("<div />").addClass(n.Settings.cssPrefix+"popup").css({visibility:"hidden",position:"absolute",zIndex:"-1"}),this.update(),this.selectioner.target.on("change",function(){i.isShown()&&(i.update(),i.reposition())}),e("body").append(this.element)},o.prototype.addDialog=function(t){var i;if(!(t instanceof n.Core.Dialog)){var o=new n.Core.Dialog,s=e(t);o.render=function(){this.element=s},t=o}t.initialize(this.selectioner),t.setPopup(this),t.render(),i=t.element,this.element.append(i),this.dialogs.push(t)},o.prototype.update=function(){for(var e=0,t=this.dialogs.length;t>e;e++)this.dialogs[e].update()},o.prototype.reposition=function(){var t=this.selectioner.display.element,n=t.offset(),i=this.element.outerWidth(!1)-this.element.width(),o=t.outerWidth(!1)-i,s=t.outerHeight(!1)+n.top,r=e(window).scrollTop(),a=this.element.outerHeight(!0);this.element.removeClass("below").removeClass("above").removeClass("over"),s+a>e(window).height()+r?(s=n.top-a+1,r>s?(s=r,this.element.addClass("over")):this.element.addClass("above")):this.element.addClass("below"),this.element.css({width:o+"px",left:n.left+"px",top:s+"px"})},o.prototype.show=function(){if(!this.selectioner.display.isDisabled()&&!this.selectioner.display.isReadOnly()){var t=this;if(e(window).one("resize.selectioner",function(){t.hide()}),!this.isShown()){this._isVisible=!0,this.update();var n=this.element.height();this.reposition(),this.element.css({visibility:"visible",zIndex:""}),n!=this.element.height()&&this.reposition(),this.selectioner.trigger("show.selectioner")}}},o.prototype.hide=function(){e(window).off("resize.selectioner"),this.isShown()&&(this._isVisible=!1,this.element.css({visibility:"hidden",zIndex:"-1"}),this.selectioner.trigger("hide.selectioner"))},o.prototype.isShown=function(){return this._isVisible},i.prototype.onKeyDown=function(e,t){switch(t.which||t.keyCode){case 27:this.hide(),this.selectioner.display.getKeyboardFocus();break;case 38:t.preventDefault(),this.hide();break;case 40:t.preventDefault(),this.show(),this.getKeyboardFocus()}};var s=n.Core.Display=function(){};s.prototype=new n.Core.KeyboardReceiver,s.prototype.initialize=function(e){this.selectioner=e,this.validateTarget(),this.createDisplay(),this.createPopup()},s.prototype.updateInteractivity=function(){var e=this.isDisabled();e?this.element.removeAttr("tabindex"):this.element.prop("tabindex",this.selectioner.target.prop("tabindex")),this.element.toggleClass("disabled",e),this.element.toggleClass("readonly",this.isReadOnly())},s.prototype.isReadOnly=function(){return!1},s.prototype.isDisabled=function(){return this.selectioner.target.is("[disabled]")},s.prototype.createDisplay=function(){var t=this;this.render(),this.update(),this.element.addClass(n.Settings.cssPrefix+"display"),this.updateInteractivity(),this.selectioner.target.closest("form").on("reset",function(){setTimeout(function(){t.update()},1)}),this.selectioner.target.on("change.selectioner",function(){t.update()});var i=this.selectioner.target.attr("id");void 0!==i&&(this.labels=e(document).on("click.selectioner",'label[for="'+i+'"]',function(){t.element.focus()}))},s.prototype.createPopup=function(){var t=this,i=this.popup=new o;i.initialize(this.selectioner);var s=this.selectioner.display.element;this.element.on("focusin.selectioner",function(){i.show(),t.getKeyboardFocus()}).children().andSelf().on("mousedown.selectioner",function(e){e.stopPropagation(),i.isShown()?i.hide():i.show()}).on("focusout",function(){t.removeKeyboardFocus()}),e(document).on("mousedown.selectioner focusin.selectioner",function(t){!i.isShown()||t.target===s[0]||e.contains(s[0],t.target)||t.target===i.element[0]||e.contains(i.element[0],t.target)||(i.hide(),i.removeKeyboardFocus())});var r=n.Settings.cssPrefix+"visible";this.selectioner.on("show.selectioner",function(){s.addClass(r)}).on("hide.selectioner",function(){s.removeClass(r)})},s.prototype.addDialog=function(e){this.popup.addDialog(e)},s.prototype.render=function(){throw Error('The render method needs to be explicity overridden, and must set "this.element" to a jQuery object.')},s.prototype.update=function(){},s.prototype.remove=function(){this.selectioner.target.off(".selectioner"),this.element.add(this.popup.element).remove()},s.prototype.getNoSelectionText=function(){var e=this.selectioner.target.data("placeholder");return e||(e=n.Settings.noSelectionText),e},s.prototype.onKeyDown=function(e,t){switch(t.which||t.keyCode){case 27:this.popup.hide();break;case 38:t.preventDefault(),this.popup.hide();break;case 40:t.preventDefault(),this.popup.show(),this.popup.getKeyboardFocus()}};var r=n.Core.Dialog=function(){};r.prototype.initialize=function(e){this.selectioner=e,this.validateTarget()},r.prototype.render=function(){throw Error('The render method needs to be explicity overridden, and must set "this.element" to a jQuery object.')},r.prototype.setPopup=function(e){this.popup=e},r.prototype.update=function(){},r.prototype.validateTarget=function(){};var a=n.Display.ListBox=function(){};a.prototype=new n.Core.Display,a.prototype.validateTarget=function(){if(!this.selectioner.target.is("select"))throw Error("ListBox expects it's underlying target element to to be a <select /> element")},a.prototype.render=function(){this.element=e("<span />"),this.textElement=e("<span />").addClass(n.Settings.cssPrefix+"text");var t=e("<span />").addClass(n.Settings.cssPrefix+"button");this.element.append(t).append(this.textElement)},a.prototype.update=function(){var e=this.selectioner.target.find("option:selected");if(this.textElement.removeClass("none"),0===e.length||e.is('option[value=""], option:empty:not([value])')){var t=this.getNoSelectionText();t?this.textElement.text(t):this.textElement.html("&nbsp;"),this.textElement.addClass("none")}else if(2>=e.length){for(var n="",i=0,o=e.length;o>i;i++)n+=e[i].text,o-1>i&&(n+=", ");this.textElement.text(n)}else this.textElement.text("Selected "+e.length+" of "+this.selectioner.target.find("option").length)};var l=n.Display.ComboBox=function(){};l.prototype=new n.Core.Display,l.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboBox expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},l.prototype.render=function(){if(this.textElement=this.selectioner.target.next(),!this.textElement.is('input[type="text"]'))throw Error('ComboBox expects the element to follow it\'s target <select /> to be an <input type="text" />');var t=this.getNoSelectionText();null!==t&&this.textElement.attr("placeholder",this.getNoSelectionText()),this.textElement.attr("autocomplete","off");var i=this.getEmptyOptions();if(0===i.length)throw Error("ComboBox elements require an empty and value-less <option></option> in their underlying <select /> elements.");this.element=e("<span />");var o=this;this.textElement.addClass(n.Settings.cssPrefix+"text").on("change.selectioner",function(){o.textChanged()});var s=e("<span />").addClass(n.Settings.cssPrefix+"button");this.selectioner.on("show.selectioner",function(){o.element.one("focusin.selectioner",function(){o.textElement.select()})}),this.selectioner.isDisabled&&(this.element.addClass("disabled"),this.textElement.prop("disabled",!0)),this.element.append(s).append(this.textElement)},l.prototype.textChanged=function(){var t=this.textElement.val().toUpperCase(),n=this.selectioner.target.find("option").filter(function(){return e(this).text().toUpperCase()==t});1!=n.length&&(n=this.getEmptyOptions()),n[0].selected=!0,this.selectioner.target.trigger("change")},l.prototype.update=function(){var e=this.selectioner.target.find("option:selected");this.textElement.removeClass("none");var t=e.text();0===e.length?this.textElement.addClass("none"):""!==t&&this.textElement.val(t)},l.prototype.getEmptyOptions=function(){return this.selectioner.target.find('option[value=""], option:empty:not([value])')},l.prototype.remove=function(){this.selectioner.target.after(this.textElement),n.Core.Display.prototype.remove.call(this)},s.prototype.getNoSelectionText=function(){var e=this.selectioner.target.data("placeholder");return e||(e=this.textElement.attr("placeholder")),e||(e=n.Settings.noSelectionText),e};var p=n.Display.DateBox=function(){};p.prototype=new n.Core.Display,p.prototype.validateTarget=function(){if(!this.selectioner.target.is('input[type="date"]'))throw Error('DateBox expects it\'s underlying target element to to be a <input type="date" /> element')},p.prototype.isReadOnly=function(){return this.selectioner.target.is("[readonly]")},p.prototype.render=function(){this.element=e("<span />"),this.textElement=e("<span />").addClass(n.Settings.cssPrefix+"text");var t=e("<span />").addClass(n.Settings.cssPrefix+"button");this.element.append(t).append(this.textElement)},p.prototype.update=function(){var e=this.selectioner.target.val();if(""!==e){var t=e.match(/(\d+)/g),n=new Date(t[0],t[1]-1,t[2]),i=this.getDateText(n);this.textElement.removeClass("none").text(i)}else this.textElement.addClass("none").text(this.selectioner.target.attr("placeholder")||"Select a date")},p.prototype.getDateText=function(e){var t=""+e.getDate(),n=""+(e.getMonth()+1),i=""+e.getFullYear();return 1==t.length&&(t="0"+t),1==n.length&&(n="0"+n),i+"-"+n+"-"+t};var c=n.Dialog.SingleSelect=function(){};c.prototype=new n.Core.Dialog,c.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('SingleSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},c.prototype.render=function(){this.element=e("<ul />")},c.prototype.update=function(){this.element.empty();for(var t=this.selectioner.target.children(),n=0,i=t.length;i>n;n++){var o=e(t[n]);"OPTION"==t[n].tagName?this.element.append(this.renderOption(o)):"OPTGROUP"==t[n].tagName&&this.element.append(this.renderGroup(o))}},c.prototype.renderOption=function(t){var i,o=this,s=t.text();i=t.is(":disabled")?e("<span />").addClass("disabled").text(s||n.Settings.emptyOptionText):e("<a />").attr("href","javascript:;").on("click",function(){o.selectOption(t)}).text(s||n.Settings.emptyOptionText);var r=e("<li />"),a=t.val();return(null===a||""===a)&&r.addClass("none"),r.append(i)},c.prototype.selectOption=function(e){e[0].selected=!0,this.popup.hide(),this.selectioner.target.trigger("change")},c.prototype.renderGroup=function(t){for(var i=e("<span />").text(t.attr("label")),o=e("<li />").addClass(n.Settings.cssPrefix+"group-title").append(i),s=t.children(),r=0,a=s.length;a>r;r++){var l=e(s[r]);o=o.add(this.renderOption(l))}var p=e("<li />").append(e("<ul >").append(o));return p};var h=n.Dialog.MultiSelect=function(){};h._inputIdIndex=0,h.prototype=new n.Dialog.SingleSelect,h.prototype.validateTarget=function(){if(!this.selectioner.target.is("select[multiple]"))throw Error('MultiSelect expects it\'s underlying target element to to be a <select /> element with a "multiple" attribute')},h.prototype.renderOption=function(t){var n=e("<li />"),i="MultiSelectCheckbox"+h._inputIdIndex++,o=e('<input type="checkbox" />').data("option",t).attr("id",i);t[0].selected&&o.attr("checked","checked");var s=e("<label />").append(o).append(e("<span />").text(t.text())).attr("for",i),r=this.selectioner;return o.on("change.selectioner",function(){t[0].selected=this.checked,r.target.trigger("change")}),t.is(":disabled")&&(s.addClass("disabled"),o.prop("disabled",!0)),n.append(s),n},h.prototype.renderGroup=function(t){for(var i=this,o=function(){var t=e(this).closest("ul").find("input:checkbox:not(:disabled)"),n=t.filter(":checked").length;t.prop("checked",n!=t.length||0===n).each(function(){e(this).data("option")[0].selected=this.checked}),i.selectioner.target.trigger("change")},s=e("<a />").attr("href","javascript:;").on("click",o).text(t.attr("label")),r=e("<li />").addClass(n.Settings.cssPrefix+"group-title").append(s),a=t.children(),l=0,p=a.length;p>l;l++){var c=e(a[l]);r=r.add(this.renderOption(c))}var h=e("<li />").append(e("<ul >").append(r));return h};var d=n.Dialog.ComboSelect=function(){};d.prototype=new n.Dialog.SingleSelect,d.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},d.prototype.renderOption=function(e){return e.is('option[value=""], option:empty:not([value])')?null:n.Dialog.SingleSelect.prototype.renderOption.call(this,e)};var u=n.Dialog.AutoComplete=function(){};u.prototype=new n.Core.Dialog,u.prototype.validateTarget=function(){if(!this.selectioner.target.is("select:not([multiple])"))throw Error('ComboSelect expects it\'s underlying target element to to be a <select /> element without a "multiple" attribute')},u.prototype.render=function(){if(this.textElement=this.selectioner.display.element.find('input[type="text"]'),0===this.textElement.length)throw Error('AutoComplete expects the Display to contain an <input type="text" /> element');this.element=e("<ul />"),this.update(),this._textValue=this.textElement.val();var t=this;this.textElement.on("keyup change",function(){t._textValue!==t.textElement.val()&&(t.update(),t.popup.isShown()?t.popup.reposition():t.popup.show(),t._textValue=t.textElement.val())}),this.update()},u.prototype.update=function(){for(var t=this,i=function(n){var i=e("<a />").attr("href","javascript:;").text(n.text()).on("click",function(){n[0].selected=!0,t.popup.hide(),t.selectioner.target.trigger("change")});return e("<li />").append(i)},o=this.textElement.val().toLowerCase(),s=this.selectioner.target.find("option"),r=e(),a=0,l=s.length;l>a;a++){var p=e(s[a]),c=p.text().toLowerCase();if(""!==c&&0===c.indexOf(o)&&(r=r.add(i(p)),r.length>n.Settings.maxAutoCompleteItems))break}this.element.empty().append(r)};var g=n.Dialog.DateSelect=function(){};g.prototype=new n.Core.Dialog,g.Settings={dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],shortDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],weekStartIndex:1},g.prototype.validateTarget=function(){if(!this.selectioner.target.is('input[type="date"]'))throw Error('DateBox expects it\'s underlying target element to to be a <input type="date" /> element')},g.prototype.render=function(){this.element=e("<div />").addClass(n.Settings.cssPrefix+"date"),this.renderDays(this.getDate())},g.prototype.update=function(){this.renderDays(this.getDate())},g.prototype.renderDays=function(e){var t=function(e){return 0===e%4&&0!==e%100||0===e%400},n=function(e,n){return[31,t(e)?29:28,31,30,31,30,31,31,30,31,30,31][n]},i=new Date(e.getFullYear(),e.getMonth()-1,28,0,0,0,0),o=n(i.getFullYear(),i.getMonth());i.setDate(o),i.setDate(o-(i.getDay()-g.Settings.weekStartIndex+7)%7);var s=new Date(i);s.setDate(s.getDate()+42),s=s,this.element.empty().append(this.renderHeader(e,s,i)).append(this.renderBody(e,s,i))},g.prototype.renderBody=function(t,n,i){for(var o=this,s=e("<thead />"),r=e("<tr />"),a=g.Settings.shortDayNames,l=0,p=a.length;p>l;l++)r.append(e("<th />").text(a[(l+g.Settings.weekStartIndex)%7]));s.append(r);var c=e("<tbody />"),h=[],d=new Date(i.valueOf()),u=t.getMonth(),f=this.getToday().valueOf(),y=new Date(this.getDate().valueOf());y.setHours(0),y.setMinutes(0),y.setSeconds(0),y.setMilliseconds(0);for(var m=y.valueOf();d.valueOf()<n.valueOf();){var v=d.valueOf(),x=d.getDate(),w=d.getDay();h.push({name:x,isWeekend:0===w||6===w,isNextMonth:d.getMonth()>u,isPrevMonth:u>d.getMonth(),isToday:f===v,isSelected:m===v,dateValue:v}),d.setDate(x+1)}for(var b=function(e){var t=""+e.getDate(),n=""+(e.getMonth()+1),i=""+e.getFullYear();return 1==t.length&&(t="0"+t),1==n.length&&(n="0"+n),i+"-"+n+"-"+t},D=function(t){var n=new Date(t.dateValue),i=e("<td />").text(t.name).on("click",function(){o.selectioner.target.val(b(n)).trigger("change.selectioner"),o.popup.hide(),o.renderDays(o.getDate())});return t.isWeekend&&i.addClass("weekend"),t.isNextMonth&&i.addClass("next-month"),t.isPrevMonth&&i.addClass("prev-month"),t.isToday&&i.addClass("today"),t.isSelected&&i.addClass("selected"),i},S=0,C=h.length/7;C>S;S++){for(var E=e("<tr />"),T=0;7>T;T++)E.append(D(h[7*S+T]));c.append(E)}return e("<table />").append(s).append(c)},g.prototype.renderHeader=function(t,n,i){var o=this,s=e("<span />").text(this.getHeaderText(t)),r=e("<a />").attr("href","javascript:;").addClass("next").text("›").on("click",function(){o.renderDays(n)}),a=e("<a />").attr("href","javascript:;").addClass("prev").text("‹").on("click",function(){o.renderDays(i)});return e("<div />").append(a).append(s).append(r)},g.prototype.getHeaderText=function(e){return g.Settings.shortMonthNames[e.getMonth()]+" "+e.getFullYear()},g.prototype.getDate=function(){var e=this.selectioner.target.val();if(""!==e){var t=e.match(/(\d+)/g);return new Date(t[0],t[1]-1,t[2])}return this.getToday()},g.prototype.getToday=function(){var e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e},e.fn.singleSelect=function(){return this.each(function(){new n(this,new n.Display.ListBox,new n.Dialog.SingleSelect)}),this},e.fn.multiSelect=function(){return this.each(function(){new n(this,new n.Display.ListBox,new n.Dialog.MultiSelect)}),this},e.fn.comboSelect=function(e){return this.each(function(){new n(this,new n.Display.ComboBox(e),new n.Dialog.ComboSelect)}),this},e.fn.autoComplete=function(){return this.each(function(){new n(this,new n.Display.ComboBox,new n.Dialog.AutoComplete)}),this},e.fn.dateSelect=function(){return this.each(function(){new n(this,new n.Display.DateBox,new n.Dialog.DateSelect)}),this}})(jQuery);